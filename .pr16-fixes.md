# PR #16 Review Fixes — All 47 Items

Make ALL of the following changes. Do NOT skip any. After all changes, run `pnpm lint:fix`, then `pnpm test` to verify everything passes.

## CRITICAL (do first)

### Fix 1: Run `pnpm lint:fix` to fix 348 Biome lint errors
Run it and fix any remaining errors manually.

### Fix 2: Wrong event name in src/modules/events.js
Change `client.once('clientReady')` to `client.once(Events.ClientReady)`.
Add `import { Events } from 'discord.js';` at the top of the file.

### Fix 3: coverage/ directory tracked in git
Run `git rm -r --cached coverage/` to untrack it.

### Fix 4: Duplicate coverage/ entry in .gitignore
The .gitignore has `coverage/` listed twice. Remove the duplicate, keep only one entry.

## SOURCE CODE FIXES

### Fix 5: Pin pnpm/action-setup to commit SHA in .github/workflows/ci.yml
Change `uses: pnpm/action-setup@v4` to `uses: pnpm/action-setup@7088e561eb65bb68695d245aa206f005ef30921d # v4.1.0`

### Fix 6: Update AGENTS.md Node.js version
Change `**Runtime:** Node.js 18+ (ESM modules, `"type": "module"`)` to `**Runtime:** Node.js 22 (ESM modules, `"type": "module"`)` in AGENTS.md.

### Fix 7: Pin claude-code-action in .github/workflows/claude-review.yml
Change `uses: anthropics/claude-code-action@beta` to `uses: anthropics/claude-code-action@5f50869ee49df3519130cce67383db1b07e8d701 # v1.0.48`

### Fix 8: Fix "pnpm deploy" in AGENTS.md
Change `pnpm deploy` to `pnpm run deploy` in the text around line 91 of AGENTS.md.

### Fix 9: Add `text` language specifier in CONTRIBUTING.md
Around line 27, there's a code block with no language specifier for the commit message examples. Change the opening fence from ``` to ```text.

### Fix 10: Add `text` language specifier in README.md
The ASCII architecture diagram code block (around line 21) has no language specifier. Change ``` to ```text.

### Fix 11: Sanitize path/truncatedValue in src/commands/config.js
In the handleSet function, around lines 299-305 where embed fields are added, the `path` and `truncatedValue` are put inside backticks but not sanitized. Change:
```js
{ name: 'Path', value: `\`${path}\``, inline: true },
{ name: 'New Value', value: `\`${truncatedValue}\``, inline: true },
```
to:
```js
{ name: 'Path', value: `\`${escapeInlineCode(path)}\``, inline: true },
{ name: 'New Value', value: `\`${escapeInlineCode(truncatedValue)}\``, inline: true },
```

### Fix 12: Log warning when command file skipped in src/deploy-commands.js
In the loadCommands function, when a command file doesn't have `data` and `execute`, log a warning. Change:
```js
if (command.data && command.execute) {
  commands.push(command);
}
```
to:
```js
if (command.data && command.execute) {
  commands.push(command);
} else {
  warn(`Skipping ${file}: missing "data" or "execute" export`);
}
```
Import `warn` from the logger.

### Fix 13: Fix level.toUpperCase() corrupting ANSI codes in src/logger.js
In the consoleFormat printf function, `level.toUpperCase()` is called but after colorize() the `level` contains ANSI codes. The fix: use `originalLevel.toUpperCase()` instead. Change:
```js
return `${prefix} [${timestamp}] ${level.toUpperCase()}: ${message}${metaStr}`;
```
to:
```js
return `${prefix} [${timestamp}] ${(originalLevel || level).toUpperCase()}: ${message}${metaStr}`;
```

### Fix 14: PII in spam log in src/modules/events.js
Around line 63-68, the spam warning logs `message.author.tag` and `message.content`. Change to use `message.author.id` and redact content:
```js
warn('Spam detected', { userId: message.author.id, contentPreview: '[redacted]' });
```

### Fix 15: Optional chaining in accumulate catch handler in src/modules/events.js
Around line 122-124, change `err.message` to `err?.message`:
```js
accumulate(message, config).catch((err) => {
  logError('ChimeIn accumulate error', { error: err?.message });
});
```

### Fix 16: Include stack trace in welcome.js error logging
In src/modules/welcome.js, around line 98-100, change:
```js
logError('Welcome error', { error: err.message });
```
to:
```js
logError('Welcome error', { error: err.message, stack: err.stack });
```

### Fix 17: Include stack trace in src/utils/registerCommands.js error logging
Around line 55-57, change:
```js
logError('Failed to register commands', { error: err.message });
```
to:
```js
logError('Failed to register commands', { error: err.message, stack: err.stack });
```

### Fix 18: Fix ETIMEDOUT classification in src/utils/errors.js
The first check has ETIMEDOUT in the NETWORK codes alongside ECONNREFUSED and ENOTFOUND. Remove ETIMEDOUT from this first check so it falls through to the TIMEOUT check below. Change:
```js
if (code === 'ECONNREFUSED' || code === 'ENOTFOUND' || code === 'ETIMEDOUT') {
    return ErrorType.NETWORK;
  }
  if (code === 'ETIMEDOUT' || message.includes('timeout')) {
```
to:
```js
if (code === 'ECONNREFUSED' || code === 'ENOTFOUND') {
    return ErrorType.NETWORK;
  }
  if (code === 'ETIMEDOUT' || message.includes('timeout')) {
```

## TEST IMPROVEMENTS

### Fix 19: tests/commands.test.js — Move import to beforeAll
Move the dynamic import of command modules from top-level shared mutable state to a `beforeAll` block.

### Fix 20: tests/commands.test.js — Document side effects
Add a JSDoc comment at the top explaining that dynamic imports execute module-level side effects.

### Fix 21: tests/commands/ping.test.js — Extract mock factory
Extract the repeated mock interaction creation into a `createMockInteraction()` helper function.

### Fix 22: tests/config.test.js (root tests/) — Extract readFileSync into beforeAll
If readFileSync is called repeatedly to read config, extract it into a beforeAll or beforeEach.

### Fix 23: tests/db.test.js — Save/restore process.env.DATABASE_URL
In beforeEach save the original DATABASE_URL, and in afterEach restore it.

### Fix 24: tests/logger.test.js — Verify actual redaction output
Instead of just checking "no throw", assert that sensitive fields actually show '[REDACTED]' in the output.

### Fix 25: tests/logger.test.js — Note module caching for shared imports
Add a comment explaining that Winston logger is a module-level singleton and the shared import is cached by Node.

### Fix 26: tests/modules/ai.test.js — Fix Authorization header test
Find the test that checks the Authorization header and actually verify the header value contains the expected API key.

### Fix 27: tests/commands/config.test.js — Use embed.toJSON().fields
Change `embed.data.fields` to `embed.toJSON().fields` for accessing embed fields.

### Fix 28: tests/commands/config.test.js — Add comment about null→undefined coercion
Add a comment explaining that discord.js coerces null to undefined in some embed fields.

### Fix 29: tests/commands/status.test.js — Assert formatted time strings
In formatRelativeTime tests, assert the actual formatted string values, not just truthiness.

### Fix 30: tests/commands/status.test.js — Assert actual emoji in getStatusEmoji
Assert the actual emoji character returned, not just that something is returned.

### Fix 31: tests/index.test.js — Store handlers in arrays for event collisions
When capturing event handlers, use arrays to avoid overwriting if multiple handlers are registered for the same event.

### Fix 32: tests/index.test.js — Note importIndex microtask settling
Add a comment explaining that the microtask settling approach is pragmatic.

### Fix 33: tests/modules/chimeIn.test.js — Add negative assertions for early-exit
For tests where early-exit is expected, assert that fetch was NOT called.

### Fix 34: tests/modules/chimeIn.test.js — Spy on fetch for channels list test
Use a spy on global fetch for the test that checks channels list fetching.

### Fix 35: tests/modules/config.test.js — Remove dead mock variables
Remove unused mock variables like `_mockQuery` etc.

### Fix 36: tests/modules/config.test.js — Extract repeated no-DB setup
Extract repeated no-DB configuration setup into a nested describe block.

### Fix 37: tests/modules/config.test.js — Add comments about mutable cache coupling
Add comments explaining the cache coupling behavior with mutable config.

### Fix 38: tests/modules/events.test.js — Use vi.spyOn(process, 'on')
Replace monkey-patching of process.on with `vi.spyOn(process, 'on')` in both test areas.

### Fix 39: tests/modules/spam.test.js — Add test for config.moderation undefined
Add a test case where `config.moderation` is undefined.

### Fix 40: tests/modules/spam.test.js — Assert message.delete not called when autoDelete disabled
Add an assertion that `message.delete` is NOT called when autoDelete is disabled/false.

### Fix 41: tests/utils/errors.test.js — Update ETIMEDOUT test
Update the ETIMEDOUT test to expect ErrorType.TIMEOUT instead of ErrorType.NETWORK (matches source fix #18).

### Fix 42: tests/utils/errors.test.js — Note over-broad ENOENT classification
Add a comment noting that ENOENT being classified as CONFIG_MISSING is over-broad (it catches any file-not-found, not just config files).

### Fix 43: tests/utils/health.test.js — Note singleton reset fragility
Add a comment or add a `resetInstance()` method to HealthMonitor explaining that the singleton pattern makes test isolation fragile.

### Fix 44: tests/utils/permissions.test.js — Add positive-path test for admin
Add a test verifying that an admin (with the admin role ID) IS allowed to use unknown commands.

## FINAL STEPS
1. Run `pnpm lint:fix` then `pnpm lint` to ensure no lint errors
2. Run `pnpm test` to ensure all tests pass with 80%+ coverage
3. Do NOT commit — I will handle git operations
